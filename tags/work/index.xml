<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>work - 标签 - 打工人日志 - jobcher</title>
        <link>http://www.jobcher.com/tags/work/</link>
        <description>work - 标签 - 打工人日志 - jobcher</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>nb@nbtyfood.com (jobcher)</managingEditor>
            <webMaster>nb@nbtyfood.com (jobcher)</webMaster><lastBuildDate>Fri, 25 Nov 2022 00:00:00 &#43;0000</lastBuildDate><atom:link href="http://www.jobcher.com/tags/work/" rel="self" type="application/rss+xml" /><item>
    <title>Jenkins 编译Android apk 流水线</title>
    <link>http://www.jobcher.com/gradle-apk/</link>
    <pubDate>Fri, 25 Nov 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/gradle-apk/</guid>
    <description><![CDATA[<h2 id="背景">背景</h2>
<p>Jenkins 编译Android apk，上传apk包，生成下载二维码，并推送钉钉</p>
<h2 id="安装android-环境">安装Android 环境</h2>
<h3 id="安装jdk">安装JDK</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 这里使用的是openjdk 1.8.0版本，有需要的话需要到java官网上进行下载对应的JDK版本。</span>
</span></span><span class="line"><span class="cl">$ yum install java -y
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 其他版本JDK的安装方式</span>
</span></span><span class="line"><span class="cl">$ mv jdk1.8.0_161 /usr/local/
</span></span><span class="line"><span class="cl">$ ln -s /usr/local/jdk1.8.0_161 /usr/local/jdk
</span></span><span class="line"><span class="cl">$ vim /etc/profile     <span class="c1">#配置JDK的环境变量</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$JAVA_HOME</span>/jre/bin:<span class="nv">$PATH</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLASSPATH</span><span class="o">=</span>.<span class="nv">$CLASSPATH</span>:<span class="nv">$JAVA_HOME</span>/lib:<span class="nv">$JAVA_HOME</span>/jre/lib:<span class="nv">$JAVA_HOME</span>/lib/tools.jar
</span></span><span class="line"><span class="cl">$ <span class="nb">source</span> /etc/profile    <span class="c1">#重新加载系统环境变量</span>
</span></span><span class="line"><span class="cl">$ java -version    <span class="c1">#查看java版本</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="android-sdk安装">Android SDK安装</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 下载sdk工具包</span>
</span></span><span class="line"><span class="cl">$ wget https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 创建sdk工具文件夹和解压工具包</span>
</span></span><span class="line"><span class="cl">$ mkdir  -p /opt/android/sdk
</span></span><span class="line"><span class="cl">$ unzip sdk-tools-linux-3859397.zip -d /opt/android/sdk
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 使用sdkmanager工具配置构建工具和平台版本</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /opt/android/sdk/tools/bin/
</span></span><span class="line"><span class="cl">$ ./sdkmanager <span class="s2">&#34;build-tools;29.0.6&#34;</span> <span class="s2">&#34;platforms;android-29&#34;</span> <span class="s2">&#34;platform-tools&#34;</span> 
</span></span><span class="line"><span class="cl">$ ./sdkmanager --list    <span class="c1">#可以查看有哪些版本，自行选择对应的版本</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 增加系统环境变量</span>
</span></span><span class="line"><span class="cl">$ vim /etc/profile
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ANDROID_HOME</span><span class="o">=</span>/opt/android/sdk
</span></span><span class="line"><span class="cl"><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$ANDROID_HOME</span>:<span class="nv">$ANDROID_HOME</span>/tools:<span class="nv">$ANDROID_HOME</span>/platform-tools:<span class="nv">$ANDROID_HOME</span>/emulator:<span class="nv">$ANDROID_HOME</span>/tools/bin
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">$ adb version
</span></span><span class="line"><span class="cl">Android Debug Bridge version 1.0.41
</span></span><span class="line"><span class="cl">Version 29.0.6-6198805
</span></span><span class="line"><span class="cl">Installed as /opt/android/sdk/platform-tools/adb
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装gradle">安装gradle</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ wget https://downloads.gradle-dn.com/distributions/gradle-6.3-all.zip
</span></span><span class="line"><span class="cl">$ mkdir /opt/gradle
</span></span><span class="line"><span class="cl">$ unzip gradle-6.3-all.zip -d /opt/gradle/
</span></span><span class="line"><span class="cl">$ vim /etc/profile
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/gradle/gradle-6.3/bin
</span></span><span class="line"><span class="cl">$ <span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl">$ gradle -v
</span></span><span class="line"><span class="cl">------------------------------------------------------------
</span></span><span class="line"><span class="cl">Gradle 6.3
</span></span><span class="line"><span class="cl">------------------------------------------------------------
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Build time:   2020-03-24 19:52:07 UTC
</span></span><span class="line"><span class="cl">Revision:     bacd40b727b0130eeac8855ae3f9fd9a0b207c60
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Kotlin:       1.3.70
</span></span><span class="line"><span class="cl">Groovy:       2.5.10
</span></span><span class="line"><span class="cl">Ant:          Apache Ant<span class="o">(</span>TM<span class="o">)</span> version 1.10.7 compiled on September <span class="m">1</span> <span class="m">2019</span>
</span></span><span class="line"><span class="cl">JVM:          1.8.0_201 <span class="o">(</span>Oracle Corporation 25.201-b09<span class="o">)</span>
</span></span><span class="line"><span class="cl">OS:           Linux 3.10.0-693.el7.x86_64 amd64
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jenkins-流水线配置">jenkins 流水线配置</h2>
<h3 id="gradle-jdksh-打包脚本">gradle-jdk.sh 打包脚本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">source</span> /etc/profile
</span></span><span class="line"><span class="cl"><span class="c1"># /home/编译目录</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/编译目录 <span class="o">&amp;&amp;</span> gradle clean
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/编译目录 <span class="o">&amp;&amp;</span> gradle assembleRelease
</span></span><span class="line"><span class="cl"><span class="c1"># 打包编译完成，在项目的app/build/outputs/apk中可以找到debug版本或者是release版本。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="jenkinsfile-脚本">JenkinsFile 脚本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">pipeline</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//使用标签 &#39;master&#39; 的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">agent</span> <span class="err">{label</span> <span class="err">&#39;master&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//环境变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">environment</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//成功运行特征
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="err">JEN_FEATURE</span> <span class="err">=</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//日志路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="err">JEN_LOG</span> <span class="err">=</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="err">stages</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">stage</span> <span class="err">(&#39;编译打包&#39;){</span>
</span></span><span class="line"><span class="cl">            <span class="err">steps</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="err">&#39;cd</span> <span class="err">/home/编译目录</span> <span class="err">&amp;&amp;</span> <span class="err">sudo</span> <span class="err">git</span> <span class="err">pull&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="err">&#39;sh</span> <span class="err">gradle-apk.sh&#39;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="err">stage</span> <span class="err">(&#39;上传&#39;)</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">steps</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="err">&#39;sshpass</span> <span class="err">-p</span> <span class="nt">&#34;password&#34;</span> <span class="err">scp</span> <span class="err">/home/编译目录/app/build/outputs/apk/release/app-release.apk</span> <span class="err">user@www.nginx.com</span><span class="p">:</span><span class="err">/home/上传目录/app-release.apk&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="err">stage</span> <span class="err">(&#39;生成qr&#39;)</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">steps</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">                <span class="err">echo</span> <span class="nt">&#34;生成test qr&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="s2">&#34;pwd &amp;&amp; myqr &#39;https://www.nginx.com/app-release.apk&#39; -n qrcode-`date +&#39;%Y-%m-%d-%H%M%S&#39;`.png -d /home/code/image&#34;</span> 
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="s2">&#34;cd /home/code/image &amp;&amp; git add .&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="s2">&#34;cd /home/code/image &amp;&amp; git commit -m &#39;new images&#39;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">sh</span> <span class="s2">&#34;cd /home/code/image &amp;&amp; git push origin main&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">echo</span> <span class="s2">&#34;结束 end&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="err">post</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">success</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">script</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">                <span class="err">env.DATETIME</span> <span class="err">=</span> <span class="err">sh(script:</span><span class="nt">&#34;date&#34;</span><span class="p">,</span> <span class="err">returnStdout:</span> <span class="err">true).trim()</span>
</span></span><span class="line"><span class="cl">                <span class="err">env.QRCODE</span> <span class="err">=</span> <span class="err">sh(script:</span><span class="nt">&#34;ls -lhst /home/code/image | awk &#39;NR==2&#39; | awk &#39;{print \$10}&#39;&#34;</span><span class="p">,</span><span class="err">returnStdout:</span> <span class="err">true).trim()</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">job_name</span> <span class="err">=</span> <span class="nt">&#34;# ${JOB_NAME} 流水线 执行成功&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">jenkinsid</span> <span class="err">=</span> <span class="s2">&#34;&#34;&#34;构建:  第 ${BUILD_ID} 次执行&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">JEN_production</span> <span class="err">=</span> <span class="s2">&#34;&gt; 部署节点： jenkins&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">build_url</span> <span class="err">=</span> <span class="s2">&#34;&gt; 部署详情： [详情](${BUILD_URL})&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">jen_date</span> <span class="err">=</span> <span class="s2">&#34;&gt; 执行时间： ${env.DATETIME}&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">jen_qrcode</span> <span class="err">=</span> <span class="s2">&#34;![qr](https://gitlab.com/jobcher/image/-/raw/main/${env.QRCODE})&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="err">dingtalk</span> <span class="err">(</span>
</span></span><span class="line"><span class="cl">                    <span class="err">robot</span><span class="p">:</span> <span class="err">&#39;e</span><span class="mi">3999649</span><span class="err">-d</span><span class="mi">3</span><span class="err">f-钉钉key</span><span class="mi">-4</span><span class="err">c</span><span class="mi">57333</span><span class="err">a</span><span class="mi">327</span><span class="err">b&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">type:</span> <span class="err">&#39;MARKDOWN&#39;,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">title:</span> <span class="err">job_name,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">text:</span> <span class="err">[</span>
</span></span><span class="line"><span class="cl">                        <span class="err">job_name,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">jenkinsid,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;---&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">jen_qrcode,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">JEN_production,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">build_url,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">jen_date</span>
</span></span><span class="line"><span class="cl">                        <span class="err">],</span>
</span></span><span class="line"><span class="cl">                    <span class="err">at:</span> <span class="err">[</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;手机号&#39;</span>
</span></span><span class="line"><span class="cl">                        <span class="err">]</span>
</span></span><span class="line"><span class="cl">                <span class="err">)</span>            
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="err">failure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">script</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">                <span class="err">env.DATETIME</span> <span class="err">=</span> <span class="err">sh(script:</span><span class="nt">&#34;date&#34;</span><span class="p">,</span> <span class="err">returnStdout:</span> <span class="err">true).trim()</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">job_name</span> <span class="err">=</span> <span class="nt">&#34;# ${JOB_NAME} 流水线 执行失败&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">jenkinsid</span> <span class="err">=</span> <span class="s2">&#34;&#34;&#34;构建:  第 ${BUILD_ID} 次执行&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">JEN_production</span> <span class="err">=</span> <span class="s2">&#34;&gt; 部署节点： jenkins&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">build_url</span> <span class="err">=</span> <span class="s2">&#34;&gt; 部署详情： [详情](${BUILD_URL})&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="err">def</span> <span class="err">jen_date</span> <span class="err">=</span> <span class="s2">&#34;&gt; 执行时间： ${env.DATETIME}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="err">dingtalk</span> <span class="err">(</span>
</span></span><span class="line"><span class="cl">                    <span class="err">robot</span><span class="p">:</span> <span class="err">&#39;e</span><span class="mi">3999649</span><span class="err">-d</span><span class="mi">3</span><span class="err">f-钉钉key</span><span class="mi">-4</span><span class="err">c</span><span class="mi">57333</span><span class="err">a</span><span class="mi">327</span><span class="err">b&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">type:</span> <span class="err">&#39;MARKDOWN&#39;,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">title:</span> <span class="err">job_name,</span>
</span></span><span class="line"><span class="cl">                    <span class="err">text:</span> <span class="err">[</span>
</span></span><span class="line"><span class="cl">                        <span class="err">job_name,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">jenkinsid,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;---&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">JEN_production,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">build_url,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;&#39;,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">jen_date</span>
</span></span><span class="line"><span class="cl">                        <span class="err">],</span>
</span></span><span class="line"><span class="cl">                    <span class="err">at:</span> <span class="err">[</span>
</span></span><span class="line"><span class="cl">                        <span class="err">&#39;手机号&#39;</span>
</span></span><span class="line"><span class="cl">                        <span class="err">]</span>
</span></span><span class="line"><span class="cl">                <span class="err">)</span>            
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item><item>
    <title>Nexus3 使用和部署</title>
    <link>http://www.jobcher.com/nexus/</link>
    <pubDate>Mon, 31 Oct 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/nexus/</guid>
    <description><![CDATA[<h2 id="nexus3-docker-compose-安装">Nexus3 docker-compose 安装</h2>
<p>创建外部存储</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -p /data/nexus
</span></span><span class="line"><span class="cl">chmod +777 -R /data/nexus
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行docker-compose</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">version: <span class="s1">&#39;3&#39;</span>
</span></span><span class="line"><span class="cl">services:
</span></span><span class="line"><span class="cl">  nexus3:
</span></span><span class="line"><span class="cl">    image: sonatype/nexus3:3.42.0
</span></span><span class="line"><span class="cl">    container_name: nexus3
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      - 8081:8081
</span></span><span class="line"><span class="cl">      - 5000:5000
</span></span><span class="line"><span class="cl">    volumes:
</span></span><span class="line"><span class="cl">      - /data/nexus:/nexus-data
</span></span><span class="line"><span class="cl">    environment:
</span></span><span class="line"><span class="cl">      - <span class="nv">INSTALL4J_ADD_VM_PARAMS</span><span class="o">=</span>-Xms1024m -Xmx1024m -XX:MaxDirectMemorySize<span class="o">=</span>1024m -Djava.util.prefs.userRoot<span class="o">=</span>/some-other-dir
</span></span><span class="line"><span class="cl">    restart: always
</span></span><span class="line"><span class="cl">    <span class="c1"># 赋予外部root权限</span>
</span></span><span class="line"><span class="cl">    privileged: <span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>docker-compose up -d
运行docker-compose</p>
</blockquote>
<h2 id="heading"></h2>
]]></description>
</item><item>
    <title>shell 脚本（1）</title>
    <link>http://www.jobcher.com/shell1/</link>
    <pubDate>Sun, 20 Mar 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/shell1/</guid>
    <description><![CDATA[<h1 id="shell脚本之变量">shell脚本之<code>变量</code></h1>
<h2 id="变量替换">变量替换</h2>
<table>
<thead>
<tr>
<th style="text-align:left">语法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">${变量名#匹配规则}</td>
<td style="text-align:left">从变量<code>开头</code>进行规则匹配，将符合最<code>短</code>的数据删除</td>
</tr>
<tr>
<td style="text-align:left">${变量名##匹配规则}</td>
<td style="text-align:left">从变量<code>开头</code>进行规则匹配，将符合最<code>长</code>的数据删除</td>
</tr>
<tr>
<td style="text-align:left">${变量名%匹配规则}</td>
<td style="text-align:left">从变量<code>尾部</code>进行规则匹配，将符合最<code>短</code>的数据删除</td>
</tr>
<tr>
<td style="text-align:left">${变量名%%匹配规则}</td>
<td style="text-align:left">从变量<code>尾部</code>进行规则匹配，将符合最<code>长</code>的数据删除</td>
</tr>
<tr>
<td style="text-align:left">${变量名/旧字符串/新字符串}</td>
<td style="text-align:left">变量内容符合旧字符串则，则<code>第一个</code>旧字符串会被新字符串取代</td>
</tr>
<tr>
<td style="text-align:left">${变量名//旧字符串/新字符串}</td>
<td style="text-align:left">变量内容符合旧字符串则，则<code>全部的</code>旧字符串会被新字符串取代</td>
</tr>
</tbody>
</table>
<h2 id="字符串处理">字符串处理</h2>
<ol>
<li>计算字符串长度</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">-</th>
<th style="text-align:left">语法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">方法一</td>
<td style="text-align:left">${#string}</td>
<td style="text-align:left">无</td>
</tr>
<tr>
<td style="text-align:left">方法二</td>
<td style="text-align:left">expr length &ldquo;$string&rdquo;</td>
<td style="text-align:left">string有空格，则必须加双引号</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>
<p>获取子串在字符串中的索引位置<br>
语法： expr index $string $substring</p>
</li>
<li>
<p>计算子串长度<br>
语法： expr match $string substr</p>
</li>
<li>
<p>抽取子串</p>
</li>
</ol>
<ul>
<li>${string:position} ：从string中的position开始</li>
<li>${string:position:length}：从position开始，匹配长度为length</li>
<li>${string:-position}：从右边开始匹配</li>
<li>${string:(position)}：从左边开始匹配</li>
<li>expr substr $string $position $length：从position开始，匹配长度为length</li>
</ul>
]]></description>
</item><item>
    <title>Maven 安装编译</title>
    <link>http://www.jobcher.com/maven/</link>
    <pubDate>Thu, 03 Mar 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/maven/</guid>
    <description><![CDATA[<h1 id="maven-安装编译">Maven 安装编译</h1>
<p>Maven就是专门为Java项目打造的管理和构建工具，它的主要功能有：</p>
<ul>
<li>提供了一套标准化的项目结构；</li>
<li>提供了一套标准化的构建流程（编译，测试，打包，发布……）；</li>
<li>提供了一套依赖管理机制。</li>
</ul>
<p>默认结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">a-maven-project
</span></span><span class="line"><span class="cl">├── pom.xml
</span></span><span class="line"><span class="cl">├── src
</span></span><span class="line"><span class="cl">│   ├── main
</span></span><span class="line"><span class="cl">│   │   ├── java
</span></span><span class="line"><span class="cl">│   │   └── resources
</span></span><span class="line"><span class="cl">│   └── <span class="nb">test</span>
</span></span><span class="line"><span class="cl">│       ├── java
</span></span><span class="line"><span class="cl">│       └── resources
</span></span><span class="line"><span class="cl">└── target
</span></span></code></pre></td></tr></table>
</div>
</div><p>项目的根目录<code>a-maven-project</code>是项目名，<br>
它有一个<code>项目描述</code>文件<code>pom.xml</code>，<br>
存放<code>Java源码</code>的目录是<code>src/main/java</code>，<br>
存放<code>资源文件</code>的目录是<code>src/main/resources</code>，<br>
存放<code>测试源码</code>的目录是<code>src/test/java</code>，<br>
存放<code>测试资源</code>的目录是<code>src/test/resources</code>，<br>
最后，所有编译、<code>打包生成的文件</code>都放在<code>target</code>目录里。<br>
这些就是一个Maven项目的标准目录结构。</p>
<p>pom.xml文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>com.itranswarp.learnjava<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>hello<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>groupId</code>类似于Java的包名，通常是公司或组织名称，<br>
<code>artifactId</code>类似于Java的类名，通常是项目名称，<br>
<code>version</code>，一个Maven工程就是由<code>groupId，artifactId和version</code>作为唯一标识。<br>
我们在引用其他第三方库的时候，也是通过这3个变量确定。</p>
<p>依赖<code>commons-logging</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用<code>&lt;dependency&gt;</code>声明一个依赖后，Maven就会自动下载这个依赖包并把它放到<code>classpath</code>中。</p>
<h2 id="安装maven">安装Maven</h2>
]]></description>
</item><item>
    <title>Nodejs 安装编译</title>
    <link>http://www.jobcher.com/nodejs/</link>
    <pubDate>Thu, 03 Mar 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/nodejs/</guid>
    <description><![CDATA[<h1 id="nodejs-安装编译">Nodejs 安装编译</h1>
<p>Node.js平台是在后端运行JavaScript代码，必须首先在本机安装Node环境。</p>
<h2 id="安装nodejs">安装Node.js</h2>
<h2 id="安装npm">安装npm</h2>
<p>npm其实是Node.js的包管理工具（package manager）。</p>
]]></description>
</item><item>
    <title>ruoyi-cloud docker部署</title>
    <link>http://www.jobcher.com/ruoyi/</link>
    <pubDate>Thu, 03 Mar 2022 00:00:00 &#43;0000</pubDate>
    <author>作者</author>
    <guid>http://www.jobcher.com/ruoyi/</guid>
    <description><![CDATA[<h2 id="基础环境安装">基础环境安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># docker 脚本安装</span>
</span></span><span class="line"><span class="cl">curl -sSL https://get.daocloud.io/docker <span class="p">|</span> sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#docker compose 脚本安装</span>
</span></span><span class="line"><span class="cl">curl -L https://get.daocloud.io/docker/compose/releases/download/v2.4.1/docker-compose-<span class="sb">`</span>uname -s<span class="sb">`</span>-<span class="sb">`</span>uname -m<span class="sb">`</span> &gt; /usr/local/bin/docker-compose 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#可执行权限</span>
</span></span><span class="line"><span class="cl">sudo chmod +x /usr/local/bin/docker-compose
</span></span><span class="line"><span class="cl"><span class="c1">#创建软链：</span>
</span></span><span class="line"><span class="cl">sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span><span class="line"><span class="cl"><span class="c1">#测试是否安装成功</span>
</span></span><span class="line"><span class="cl">docker-compose --version
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="下载安装">下载安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://gitlab.sanjiang.com/it-group/ruoyi-cloud.git
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="编译">编译</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> ruoyi-cloud
</span></span><span class="line"><span class="cl">mvn clean install -DskipTests
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="复制jar包">复制jar包</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> ./docker
</span></span><span class="line"><span class="cl">./copy.sh
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="部署docker">部署docker</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./deploy.sh base
</span></span><span class="line"><span class="cl">./deploy.sh modules
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="检查docker">检查docker</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker ps -a <span class="p">|</span> grep ruoyi
</span></span><span class="line"><span class="cl">docker logs -f ruoyi-auth
</span></span><span class="line"><span class="cl">docker logs -f ruoyi-gateway
</span></span><span class="line"><span class="cl">docker logs -f ruoyi-modules-system
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item></channel>
</rss>
